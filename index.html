
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>YubiKey Custom ID Registrar</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f0f0f0; }
    h1  { color: #333; }
    label, input, button { font-size: 16px; margin: 5px 0; display: block; }
    button { padding: 8px 16px; margin-top: 10px; cursor: pointer; }
    pre    { background: #fff; padding: 10px; border: 1px solid #ccc;
             margin-top: 20px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>YubiKey Custom ID Registrar</h1>

  <label for="customId">Nombre o ID para esta llave:</label>
  <input type="text" id="customId" placeholder="Ej: Key_001">

  <button onclick="registerKey()">Registrar y guardar</button>

  <pre id="output">Esperando registro...</pre>

  <script>
    let keyList = [];

    // Cargar datos guardados al iniciar
    if (localStorage.getItem("yubikeys")) {
      keyList = JSON.parse(localStorage.getItem("yubikeys"));
      document.getElementById("output").textContent = "üîÅ Datos cargados:\n" +
        keyList.map(e => `‚úÖ ${e.id} ‚Äì ${e.timestamp}`).join("\n") + "\n---";
    }

    async function registerKey() {
      const customId = document.getElementById("customId").value.trim();
      if (!customId) {
        alert("Por favor introduce un ID personalizado para esta llave.");
        return;
      }
      if (keyList.some(e => e.id.toLowerCase() === customId.toLowerCase())) {
        alert("‚ö†Ô∏è El nombre '" + customId + "' ya est√° en uso. Usa uno distinto.");
        return;
      }

      const publicKey = {
        challenge: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(32))),
        rp: { name: "Local Tool", id: window.location.hostname || "localhost" },
        user: {
          id: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(8))),
          name: customId + "@example.com",
          displayName: customId
        },
        pubKeyCredParams: [{ type: "public-key", alg: -7 }],
        timeout: 60000,
        attestation: "none",
        authenticatorSelection: {
          authenticatorAttachment: "cross-platform",
          userVerification: "discouraged"
        }
      };

      document.getElementById("output").textContent +=
        `\n‚è≥ Esperando toque en la YubiKey (${customId})...\n`;

      try {
        const credential = await navigator.credentials.create({ publicKey });
        const rawId = btoa(String.fromCharCode(...new Uint8Array(credential.rawId)));

        if (keyList.some(e => e.credentialId === rawId)) {
          alert("‚ùå Esta Security Key ya ha sido registrada con otro ID.");
          document.getElementById("output").textContent +=
            `‚õî Rechazado: esta llave ya fue usada.\n---`;
          return;
        }

        const entry = {
          id: customId,
          credentialId: rawId,
          timestamp: new Date().toLocaleString()
        };

        keyList.push(entry);
        localStorage.setItem("yubikeys", JSON.stringify(keyList)); // Guardar en localStorage

        document.getElementById("output").textContent +=
          `‚úÖ Registrado: ${entry.id}\nCredential ID: ${entry.credentialId}\nHora: ${entry.timestamp}\n---`;
        document.getElementById("customId").value = "";
      } catch (err) {
        document.getElementById("output").textContent += `‚ùå Error: ${err.message}\n---`;
      }
    }
  </script>
</body>
</html>
